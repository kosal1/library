<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for gulp-file-sync/index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">gulp-file-sync/</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.51% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>72/77</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">82.26% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>51/62</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.51% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>72/77</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">66×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
var gutil = require('gulp-util'),
    fs = require('fs-extra'),
    path = require('path'),
    crc = require('crc'),
    packageInfo = require('./package.json');
&nbsp;
var pluginDisplayName = packageInfo.name.replace('gulp-', '');
&nbsp;
var isIgnored = function(_options, _dir, _file) {
	if (_options.ignore) {
		if (Array.isArray(_options.ignore)) {
      // 为了让 ignore 参数更容易使用，ignore 参数支持传入数组
      // 如果 ignore 的文件为数组，则遍历数组元素并把每个元素封装成一个 options，然后重新调用 isIgnored
			return _options.ignore.some(function(_filter) {
				return isIgnored({ ignore: _filter }, _dir, _file);
			});
		} else {
			var _ignoreFileType = typeof _options.ignore;
      // 判断参数类型，转换为实际使用的类型
			if (_ignoreFileType === 'function') {
				return _options.ignore(_dir, _file);
&nbsp;
			} else <span class="missing-if-branch" title="else path not taken" >E</span>if (_ignoreFileType === 'string') {
				return _options.ignore === _file;
&nbsp;
			} else {
				// 获取匹配的文件 
<span class="cstat-no" title="statement not covered" >				var _matcheFile = _options.ignore.exec(_file);</span>
<span class="cstat-no" title="statement not covered" >				return _matcheFile &amp;&amp; _matcheFile.length &gt; 0;</span>
			}
		}
	}
	return false;
};
&nbsp;
// 判断两个文件是否为相同的文件（即文件没有变动）
var isSameFile = function(_src, _dest) {
	var _srcCrc = crc.crc32(fs.readFileSync(_src)).toString(16),
      _destCrc = crc.crc32(fs.readFileSync(_dest)).toString(16);
	return _srcCrc === _destCrc;
};
&nbsp;
// 移除文件
var remove = function(_options, _src, _dest) {
&nbsp;
	var _files = fs.readdirSync(_dest);
	_files.forEach(function(_file) {
		<span class="missing-if-branch" title="if path not taken" >I</span>if (isIgnored(_options, _dest, _file)) {
<span class="cstat-no" title="statement not covered" >			return;</span>
		}
		var _fullPathSrc = path.join(_src, _file),
        _fullPathDest = path.join(_dest, _file),
        _statDest = fs.statSync(_fullPathDest);
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (_statDest.isDirectory() &amp;&amp; !_options.recursive) {
      // 不允许递归子目录
<span class="cstat-no" title="statement not covered" >      return;</span>
    }
&nbsp;
		if (!fs.existsSync(_fullPathSrc)) {
      _options.beforeDeleteFileCallback &amp;&amp; _options.beforeDeleteFileCallback(_fullPathSrc);
&nbsp;
      // 如果一个文件不在源目录而在目标目录，则删除该文件
			fs.removeSync(_fullPathDest);
&nbsp;
      _options.deleteFileCallback(_fullPathSrc, _fullPathDest);
&nbsp;
		} else {
      var _statSrc = fs.statSync(_fullPathSrc);
			if (_statSrc.isFile() !== _statDest.isFile() || _statSrc.isDirectory() !== _statDest.isDirectory()) {
        _options.beforeDeleteFileCallback &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >_options.beforeDeleteFileCallback(_fullPathSrc);</span>
&nbsp;
        fs.removeSync(_fullPathDest);
&nbsp;
        _options.deleteFileCallback(_fullPathSrc, _fullPathDest);
&nbsp;
			} else <span class="missing-if-branch" title="if path not taken" >I</span>if (_statDest.isDirectory()) {
<span class="cstat-no" title="statement not covered" >				remove(_options, _fullPathSrc, _fullPathDest);</span>
			}
		}
	} );
};
&nbsp;
// 新增文件
var add = function(_options, _src, _dest) {
&nbsp;
	var _files = fs.readdirSync(_src);
	_files.forEach(function(_file) {
		if (isIgnored(_options, _src, _file)) {
			return;
		}
		var _fullPathSrc = path.join(_src, _file),
        _fullPathDest = path.join(_dest, _file),
        _existsDest = fs.existsSync(_fullPathDest),
        _statSrc = fs.statSync(_fullPathSrc);
		if (_statSrc.isFile()) {
			if (_existsDest) {
				var _statDest = fs.statSync(_fullPathDest);
				<span class="missing-if-branch" title="else path not taken" >E</span>if (_statDest.isFile()) {
          // 源目录与目标目录都存在该文件，判断该文件是否为相同的文件（没有被修改过）
					if (!isSameFile(_fullPathSrc, _fullPathDest)) {
            // 文件不相同，即文件被修改过，则把新文件拷贝到目标目录
&nbsp;
            _options.beforeUpdateFileCallback &amp;&amp; _options.beforeUpdateFileCallback(_fullPathSrc);
&nbsp;
            // forece 参数为 true 表明可以操作 index.js 所在目录更上层的目录内的文件
						fs.copySync(_fullPathSrc, _fullPathDest, { force: true });
&nbsp;
            _options.updateFileCallback(_fullPathSrc, _fullPathDest);
					}
				}
			} else {
        // 如果文件只存在于源目录而不在目标目录，即为新增文件，同步到目标目录
        
        _options.beforeAddFileCallback &amp;&amp; _options.beforeAddFileCallback(_fullPathSrc);
     
        // forece 参数为 true 表明可以操作 index.js 所在目录更上层的目录内的文件
				fs.copySync(_fullPathSrc, _fullPathDest, { force: true });
&nbsp;
        _options.addFileCallback(_fullPathSrc, _fullPathDest);
			}
&nbsp;
		} else <span class="missing-if-branch" title="else path not taken" >E</span>if (_statSrc.isDirectory()) {
&nbsp;
      if (!_options.recursive) {
        // 不允许递归子目录
        return;
      }
&nbsp;
			<span class="missing-if-branch" title="else path not taken" >E</span>if (!_existsDest) {
				fs.mkdirsSync(_fullPathDest);
			}
			add(_options, _fullPathSrc, _fullPathDest);
		}
	} );
};
&nbsp;
// 同步文件操作
var fileSync = function(_src, _dest, _options) {
  if (typeof(_src) !== 'string') { 
    throw new gutil.PluginError(pluginDisplayName, 'Missing source directory or type is not a string.')
  }
  if (typeof(_dest) !== 'string') {
    throw new gutil.PluginError(pluginDisplayName, 'Missing destination directory or type is not a string.')
  }
&nbsp;
	_options = _options || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
&nbsp;
  // 是否递归所有子目录的参数的默认值
  _options.recursive = (_options.recursive === undefined) || _options.recursive; 
&nbsp;
  // 新增文件时输出到控制台的默认 callback 
  _options.addFileCallback  = _options.addFileCallback || function(_fullPathSrc, _fullPathDest) {
    gutil.log('同步增加文件到 ' + _fullPathDest);
  };
&nbsp;
  // 删除文件时输出到控制台的默认 callback
  _options.deleteFileCallback  = _options.deleteFileCallback || function(_fullPathSrc, _fullPathDest) {
    gutil.log('同步删除文件 ' + _fullPathDest);
  };
&nbsp;
  // 修改文件时输出到控制台的默认 callback
  _options.updateFileCallback  = _options.updateFileCallback || function(_fullPathSrc, _fullPathDest) {
    gutil.log('同步修改文件 ' + _fullPathDest);
  };
&nbsp;
  // 检查目标目录是否存在，如果目标目录不存在则创建一个，如果目标目录不存在而直接写入文件则会 crash
  fs.ensureDirSync(_dest);
  remove(_options, _src, _dest);
  add(_options, _src, _dest);
};
&nbsp;
module.exports = fileSync;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue May 24 2016 17:41:22 GMT+0800 (CST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
